<!DOCTYPE html>
<html lang="en">

<head>
    <title>钥匙盒蓝牙连接测试</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta content="initial-dpr=2,maximum-dpr=3" name="flexible" />
    <meta name="apple-mobile-web-app-title" content="YS-0x 钥匙盒">
    <meta name="keywords" content="YS-0x 钥匙盒" />
    <meta name="description" content="YS-0x 钥匙盒蓝牙测试" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/notyf/3.10.0/notyf.min.css" integrity="sha512-ZX18S8AwqoIm9QCd1EYun82IryFikdJt7lxj6583zx5Rvr5HoreO9tWY6f2VhSxvK+48vYFSf4zFtX/t2ge62g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js" integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body style="background-color: #111;">
    <!--loading-->
    <div class="overlay" id="overlay">
        <div class="loader" id="loader"></div>
        <div class="contain-item fixed-center visible-hidden " id="scanBT">
            <h3>选择要连接的设备版本</h3>
            <button onclick="selectDeviceType(1)"
                style="height: 40px;background-color: #ffe99d;width: 200px;border-radius: 10px;">YS-0x设备</button>
            <button onclick="selectDeviceType(2)"
                style="height: 40px;background-color: #ffe99d;width: 200px;border-radius: 10px;">OKGSS101设备</button>
            <button onclick="toggleShowScanBT()" class="close-btn">X</button>
        </div>
    </div>
    <!--about-us-->
    <div class="container about-container normal-text-padding" style="color:#ffe99d">
        <div class="contain-item">
            <h2>钥匙盒蓝牙连接测试</h2>
        </div>
        <div class="contain-item">
            <label>KeyA (32位16进制):</label>
            <input type="text" id="keyAInput" value="4B6579415F666F72546573745F757365" 
                   style="width: 300px; padding: 8px; margin-top: 10px;" maxlength="32">
        </div>
        <div class="contain-item">
            <label>TokenB (12位16进制):</label>
            <input type="text" id="tokenBInput" value="546F6B656E42" 
                   style="width: 300px; padding: 8px; margin-top: 10px;" maxlength="12">
        </div>
        <div class="contain-item">
            <button onclick="scanBT()" id="scanBTBtn" class="common-btn">扫描钥匙盒设备</button>
            <button onclick="disconnect()" id="disconnectBtn" class="common-btn red-btn display-none">断开设备链接</button>
        </div>
        <div class="contain-item" id="deviceOperations" style="display: none;">
            <div style="margin: 10px 0;">
                <span>设备电量: </span>
                <span id="batteryLevel" style="font-size: 24px; font-weight: bold;">--</span>
                <span>%</span>
            </div>
            <button onclick="queryBattery()" class="common-btn" id="queryBatteryBtn">查询电量</button>
            <button onclick="openLock()" class="common-btn" id="openLockBtn" style="background-color: #4CAF50;">打开锁盒</button>
        </div>
        <span class="logs-title">连接日志</span>
        <div class="logs" id="logs">
        </div>
        <div class="contain-item">
            <span>提示：每次断开后重新连接新设备的间隔最好在10秒钟以上，网页和系统之间的服务通信没有正确断开可能导致NetworkError。请在扫描前输入正确的 KeyA 和 TokenB，不同设备型号的协议略有不同。</span>
        </div>
    </div>
    <!--footer-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/notyf/3.10.0/notyf.min.js" integrity="sha512-467grL09I/ffq86LVdwDzi86uaxuAhFZyjC99D6CC1vghMp1YAs+DqCgRvhEtZIKX+o9lR0F2bro6qniyeCMEQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let server; // GATT 服务器对象
        let writeCharacteristic; // 写入特征
        let notifyCharacteristic; // 通知特征
        let tokenA = null; // 临时会话令牌
        let keyA = null; // 设备加密密钥
        let tokenB = null; // 开锁令牌
        let golbaltype = null; // 选择的设备类型 1-YS-0x 2-OKGSS101
        let receivedData = null; // 用于存储接收到的数据

        // 设备配置数组
        const prefixArr = ['YS', 'OKGSS']; // 扫描前缀
        const serviceIdArr = [
            ['00009000-0000-1000-8000-57616c6b697a'], // YS-0x 服务UUID
            ['0000fee7-0000-1000-8000-00805f9b34fb']  // OKGSS101 服务UUID
        ];
        const writeIdArr = [
            '00009001-0000-1000-8000-57616c6b697a', // YS-0x 写入UUID
            '000036f5-0000-1000-8000-00805f9b34fb'  // OKGSS101 写入UUID
        ];
        const notifyIdArr = [
            '00009002-0000-1000-8000-57616c6b697a', // YS-0x 通知UUID
            '000036f6-0000-1000-8000-00805f9b34fb'  // OKGSS101 通知UUID
        ];
        // 设备默认密钥配置
        const defaultKeys = [
            {
                keyA: '4B6579415F666F72546573745F757365',  // YS-0x 默认KeyA
                tokenB: '546F6B656E42'                      // YS-0x 默认TokenB
            },
            {
                keyA: '3822D7382F8B7987F31263D0E8199EC9',  // OKGSS101 默认KeyA
                tokenB: '068FB0CDF158'                      // OKGSS101 默认TokenB
            }
        ];

        // 选择设备类型并填充密钥
        function selectDeviceType(type) {
            golbaltype = type;
            
            // 自动填充对应版本的默认密钥
            document.getElementById('keyAInput').value = defaultKeys[golbaltype - 1].keyA;
            document.getElementById('tokenBInput').value = defaultKeys[golbaltype - 1].tokenB;
            
            const deviceName = type === 1 ? 'YS-0x' : 'OKGSS101';
            addLogs('已选择设备类型: ' + deviceName);
            addLogs('已自动填充默认密钥，可手动修改');
            showSuccessToast('已选择 ' + deviceName + ' 设备');
            
            // 关闭选择窗口
            hideOverlay();
        }

        async function scanBT(type) {
            if (typeof navigator.bluetooth === 'undefined') {
                showErrorToast('您的浏览器不支持蓝牙API，请更换为Chrome浏览器');
                return;
            }
            if (server) {
                showErrorToast('请先断开当前设备');
                return;
            }
            
            // 如果传入了 type 参数，更新设备类型
            if (type) {
                golbaltype = type;
            }
            
            // 检查是否已选择设备类型
            if (!golbaltype) {
                showErrorToast('请先选择设备类型');
                toggleShowScanBT();
                return;
            }
            
            // 获取并验证 KeyA 和 TokenB
            const keyAInput = document.getElementById('keyAInput').value.trim();
            const tokenBInput = document.getElementById('tokenBInput').value.trim();
            
            if (!keyAInput || keyAInput.length !== 32) {
                showErrorToast('请输入正确的 KeyA (32位16进制字符)');
                return;
            }
            if (!tokenBInput || tokenBInput.length !== 12) {
                showErrorToast('请输入正确的 TokenB (12位16进制字符)');
                return;
            }
            
            keyA = hexStringToUint8Array(keyAInput);
            tokenB = hexStringToUint8Array(tokenBInput);
            
            // 选择扫描的设备前缀和服务id
            let prefix = prefixArr[golbaltype - 1];
            let serviceId = serviceIdArr[golbaltype - 1];
            
            addLogs('Scanning for Bluetooth Device...');
            showSuccessToast('扫描中，点击扫描到的设备，确定开始连接');
            showOverlay();
            showLoader();
            hideScanBT(); // 隐藏选择界面

            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: prefix }],
                    optionalServices: serviceId
                });
                
                device.addEventListener('gattserverdisconnected', onDisconnected);
                addLogs('设备名称: ' + device.name);
                addLogs('设备ID: ' + device.id);
                
                addLogs('连接 GATT 服务器...');
                server = await device.gatt.connect();
                
                addLogs('获取服务...');
                const service = await server.getPrimaryService(serviceId[0]);
                addLogs('✓ 服务连接成功');
                
                addLogs('获取特征...');
                writeCharacteristic = await service.getCharacteristic(writeIdArr[golbaltype - 1]);
                addLogs('✓ 找到写入特征');
                
                notifyCharacteristic = await service.getCharacteristic(notifyIdArr[golbaltype - 1]);
                addLogs('✓ 找到通知特征');
                
                // 监听通知
                await notifyCharacteristic.startNotifications();
                notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);
                
                hideOverlay();
                hideBtn('scanBTBtn');
                showBtn('disconnectBtn');
                document.getElementById('deviceOperations').style.display = 'flex';
                
                addLogs('设备连接成功！');
                showSuccessToast('设备连接成功');
                
                // 自动执行握手
                await performHandshake();
                
            } catch (error) {
                console.error('Error: ' + error);
                addLogs('连接失败: ' + error);
                hideOverlay();
                showErrorToast('连接失败: ' + error.message);
            }
        }

        function disconnect() {
            if (server) {
                server.disconnect();
                server = null;
                writeCharacteristic = null;
                notifyCharacteristic = null;
                tokenA = null;
                hideBtn('disconnectBtn');
                showBtn('scanBTBtn');
                document.getElementById('deviceOperations').style.display = 'none';
                document.getElementById('batteryLevel').textContent = '--';
                addLogs('设备已断开');
            }
        }
        
        function hexStringToUint8Array(hexString) {
            if (hexString.length % 2 !== 0) {
                throw new Error('Hex string length must be even');
            }
            const array = new Uint8Array(hexString.length / 2);
            for (let i = 0; i < hexString.length; i += 2) {
                array[i / 2] = parseInt(hexString.substr(i, 2), 16);
            }
            return array;
        }
        
        function uint8ArrayToHex(array) {
            return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
        }
        
        // AES-128-ECB 加密（使用 CryptoJS）
        function aesEncrypt(data, key) {
            // 将 Uint8Array 转换为 CryptoJS WordArray
            const dataWords = CryptoJS.lib.WordArray.create(data);
            const keyWords = CryptoJS.lib.WordArray.create(key);
            
            // 使用 AES-128-ECB 加密
            const encrypted = CryptoJS.AES.encrypt(dataWords, keyWords, {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.NoPadding
            });
            
            // 转换回 Uint8Array
            const encryptedHex = encrypted.ciphertext.toString(CryptoJS.enc.Hex);
            return hexStringToUint8Array(encryptedHex);
        }
        
        // AES-128-ECB 解密（使用 CryptoJS）
        function aesDecrypt(data, key) {
            // 将 Uint8Array 转换为 CryptoJS WordArray
            const dataWords = CryptoJS.lib.WordArray.create(data);
            const keyWords = CryptoJS.lib.WordArray.create(key);
            
            // 创建 CipherParams 对象
            const cipherParams = CryptoJS.lib.CipherParams.create({
                ciphertext: dataWords
            });
            
            // 使用 AES-128-ECB 解密
            const decrypted = CryptoJS.AES.decrypt(cipherParams, keyWords, {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.NoPadding
            });
            
            // 转换回 Uint8Array
            const decryptedHex = decrypted.toString(CryptoJS.enc.Hex);
            return hexStringToUint8Array(decryptedHex);
        }
        
        // 生成随机填充
        function generateRandomPadding(length) {
            return crypto.getRandomValues(new Uint8Array(length));
        }
        
        // 处理通知数据
        function handleNotification(event) {
            const encryptedData = new Uint8Array(event.target.value.buffer);
            addLogs('收到加密数据: ' + uint8ArrayToHex(encryptedData));
            
            try {
                const decryptedData = aesDecrypt(encryptedData, keyA);
                addLogs('解密数据: ' + uint8ArrayToHex(decryptedData));
                receivedData = decryptedData;
            } catch (error) {
                addLogs('解密失败: ' + error);
            }
        }
        
        // 发送加密消息
        async function sendEncryptedMessage(plainData) {
            addLogs('发送明文: ' + uint8ArrayToHex(plainData));
            const encryptedData = aesEncrypt(plainData, keyA);
            addLogs('发送密文: ' + uint8ArrayToHex(encryptedData));
            await writeCharacteristic.writeValue(encryptedData);
        }
        
        // 握手获取 TokenA
        async function performHandshake() {
            addLogs('开始握手...');
            const message = new Uint8Array(16);
            
            if (golbaltype === 1) {
                // YS-0x 协议
                message[0] = 0x01;
                message[1] = 0x00;
                // 剩余14字节随机填充
                const padding = generateRandomPadding(14);
                message.set(padding, 2);
            } else {
                // OKGSS101 协议
                message[0] = 0x06;
                message[1] = 0x01;
                message[2] = 0x01;
                message[3] = 0x01;
                // 剩余12字节保持为0
            }
            
            receivedData = null;
            await sendEncryptedMessage(message);
            
            // 等待响应
            await waitForResponse(2000);
            
            if (golbaltype === 1 && receivedData && receivedData[0] === 0x81 && receivedData[1] === 0x00) {
                tokenA = receivedData.slice(2, 6);
                addLogs('握手成功，TokenA: ' + uint8ArrayToHex(tokenA));
                showSuccessToast('握手成功');
            } else if (golbaltype === 2 && receivedData && receivedData[0] === 0x06 && receivedData[1] === 0x02) {
                tokenA = receivedData.slice(3, 7);
                addLogs('握手成功，TokenA: ' + uint8ArrayToHex(tokenA));
                showSuccessToast('握手成功');
            } else {
                addLogs('握手失败');
                showErrorToast('握手失败');
            }
        }
        
        // 查询电量
        async function queryBattery() {
            if (!tokenA) {
                showErrorToast('请先完成握手');
                return;
            }
            
            addLogs('查询电量...');
            const message = new Uint8Array(16);
            
            if (golbaltype === 1) {
                // YS-0x 协议
                message[0] = 0x10;
                message[1] = 0x02;
                // 8字节占位（0x00）
                // TokenA 放在最后4字节
                message.set(tokenA, 12);
            } else {
                // OKGSS101 协议
                message[0] = 0x02;
                message[1] = 0x01;
                message[2] = 0x01;
                message[3] = 0x01;
                // TokenA 放在第4-7字节
                message.set(tokenA, 4);
                // 剩余字节保持为0
            }
            
            receivedData = null;
            await sendEncryptedMessage(message);
            
            // 等待响应
            await waitForResponse(golbaltype === 1 ? 2000 : 3000);
            
            if (golbaltype === 1 && receivedData && receivedData[0] === 0x90 && receivedData[1] === 0x02) {
                const battery = receivedData[2];
                const batteryPercent = Math.min(battery, 100);
                document.getElementById('batteryLevel').textContent = batteryPercent;
                addLogs('电量: ' + batteryPercent + '%');
                showSuccessToast('电量: ' + batteryPercent + '%');
            } else if (golbaltype === 2 && receivedData && receivedData[0] === 0x02 && receivedData[1] === 0x02) {
                const battery = receivedData[3];  // OKGSS101 电量值在索引3
                const batteryPercent = Math.min(battery, 100);
                document.getElementById('batteryLevel').textContent = batteryPercent;
                addLogs('电量: ' + batteryPercent + '%');
                showSuccessToast('电量: ' + batteryPercent + '%');
            } else {
                addLogs('查询电量失败');
                showErrorToast('查询电量失败');
            }
        }
        
        // 打开锁盒
        async function openLock() {
            if (!tokenA) {
                showErrorToast('请先完成握手');
                return;
            }
            
            addLogs('发送开锁指令...');
            const message = new Uint8Array(16);
            
            if (golbaltype === 1) {
                // YS-0x 协议
                message[0] = 0x20;
                message[1] = 0x01;
                // TokenB (6字节)
                message.set(tokenB, 2);
                // 4字节占位 (0xFF)
                message.set([0xFF, 0xFF, 0xFF, 0xFF], 8);
                // TokenA 放在最后4字节
                message.set(tokenA, 12);
            } else {
                // OKGSS101 协议
                message[0] = 0x05;
                message[1] = 0x01;
                message[2] = 0x06;
                // TokenB (6字节)
                message.set(tokenB, 3);
                // TokenA 放在第9-12字节
                message.set(tokenA, 9);
                // 剩余字节保持为0
            }
            
            receivedData = null;
            await sendEncryptedMessage(message);
            
            // 等待响应
            await waitForResponse(2000);
            
            if (golbaltype === 1 && receivedData && receivedData[0] === 0xA0 && receivedData[1] === 0x01) {
                const status = receivedData[2];
                if (status === 0x00) {
                    addLogs('开锁成功！');
                    showSuccessToast('开锁成功！');
                } else {
                    addLogs('开锁失败，状态码: ' + status);
                    showErrorToast('开锁失败');
                }
            } else if (golbaltype === 2 && receivedData && receivedData[0] === 0x05) {
                const status = receivedData[2];
                if (status === 0x00) {
                    addLogs('开锁成功！');
                    showSuccessToast('开锁成功！');
                } else {
                    addLogs('开锁失败，状态码: ' + status);
                    showErrorToast('开锁失败');
                }
            } else {
                addLogs('开锁失败，未收到响应');
                showErrorToast('开锁失败');
            }
        }
        
        // 等待响应
        function waitForResponse(timeout) {
            return new Promise((resolve) => {
                const startTime = Date.now();
                const checkInterval = setInterval(() => {
                    if (receivedData || Date.now() - startTime > timeout) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }
        function onDisconnected(event) {
            const device = event.target;
            showErrorToast(`设备: ${device.name} 已断开连接`);
            addLogs(`设备: ${device.name} 已断开连接`);
            server = null;
            writeCharacteristic = null;
            notifyCharacteristic = null;
            tokenA = null;
            showBtn('scanBTBtn');
            hideBtn('disconnectBtn');
            document.getElementById('deviceOperations').style.display = 'none';
            document.getElementById('batteryLevel').textContent = '--';
        }

        function showSuccessToast(message) {
            let notyf = new Notyf();
            notyf.success(message);
        }

        function showErrorToast(message) {
            let notyf = new Notyf();
            notyf.error(message);
        }

        function showOverlay() {
            document.getElementById("overlay").style.display = "block";
        }

        function hideOverlay() {
            document.getElementById("overlay").style.display = "none";
            hiddenLoader();
            hideScanBT();
        }

        function showLoader() {
            document.getElementById("loader").style.display = "block";
            setTimeout(hideOverlay, 60 * 1000); //最多1分钟自动消失
            setTimeout(hiddenLoader, 60 * 1000); //最多1分钟自动消失
        }

        function hiddenLoader() {
            document.getElementById("loader").style.display = "none";
        }

        function showScanBT() {
            document.getElementById("scanBT").style.visibility = "visible";
        }

        function hideScanBT() {
            document.getElementById("scanBT").style.visibility = "hidden";
        }

        function toggleShowScanBT() {
            if (document.getElementById("overlay").style.display == "block") {
                hideOverlay();
                hideScanBT();
            } else {
                showOverlay();
                showScanBT();
            }
        }

        function hideBtn(id) {
            document.getElementById(id).style.display = "none";
        }

        function showBtn(id) {
            document.getElementById(id).style.display = "block";
        }

        function removeDisplayNone(id) {
            document.getElementById(id).classList.remove('display-none');
        }

        function addLogs(log) {
            let time = new Date().toLocaleTimeString();
            let logs = document.getElementById('logs');
            logs.innerHTML += time + ": " + log + '<br>';
            logs.scrollTop = logs.scrollHeight;
        }

        window.onload = function () {
            addLogs('页面加载完成');
            addLogs('请选择设备版本开始连接');
            // 直接弹出设备选择窗口
            toggleShowScanBT();
        }

    </script>
    <style>
        .overlay {
            display: none;
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2;
            cursor: pointer;
        }

        .loader {
            display: none;
            width: 50px;
            padding: 8px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #ffe99d;
            --_m:
                conic-gradient(#0000 10%, #000),
                linear-gradient(#000 0 0) content-box;
            -webkit-mask: var(--_m);
            mask: var(--_m);
            -webkit-mask-composite: source-out;
            mask-composite: subtract;
            animation: l3 1s infinite linear;
            position: absolute;
            top: 50%;
            left: calc(50% - 25px);
        }

        @keyframes l3 {
            to {
                transform: rotate(1turn)
            }
        }

        .contain-item {
            display: flex;
            justify-content: center;
            padding: 20px 0 12px 0;
            flex-direction: column;
            align-items: center;
            color: #ffe99d;
        }

        .close-btn {
            background-color: transparent;
            border: 1px solid #ffe99d;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: #ffe99d;
            transition: 0.3s;
        }

        .close-btn:hover {
            background-color: #ffe99d;
            color: #000;
        }

        .contain-item>*:not(:first-child) {
            margin-top: 20px;
        }

        .fixed-center {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .visible-hidden {
            visibility: hidden;
        }

        .common-btn {
            padding: 8px 50px;
            border-radius: 5px;
            background-color: #ffe99d;
            color: #000;
            font-size: 16px;
            cursor: pointer;
        }

        .red-btn {
            background-color: #fd3131;
        }

        .display-none {
            display: none;
            border: none;
        }

        .logs-title {
            display: flex;
            width: 100%;
            justify-content: center;
            margin-top: 26px;
        }

        .logs {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ffe99d;
            margin: 10px 20px 0px 20px;
        }

        *::-webkit-scrollbar {
            width: 4px;
            /* 设置滚动条的宽度为1px */
        }

        *::-webkit-scrollbar-thumb {
            background-color: #ffe99d;
            /* 设置滚动条按钮的颜色为蓝色 */
        }
    </style>
</body>

</html>