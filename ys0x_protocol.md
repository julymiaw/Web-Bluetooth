# YS-0x 钥匙盒蓝牙通信协议

## 设备连接信息

**设备识别**
- 设备名称：`YS-03` 或 `YS-04`
- 服务 UUID：`00009000-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- 写入特征：`00009001-xxxx` (WRITE NO RESPONSE)
- 通知特征：`00009002-xxxx` (NOTIFY)

## 加密机制

- **算法**：AES-128-ECB
- **密钥**：每台设备有唯一的 KeyA（16字节）
- **消息长度**：固定16字节，不足部分随机填充
- **加密范围**：所有收发消息都需用 KeyA 加密

**加密示例**
```
明文: 01 00 34 4C 6F 63 6B 55 70 42 79 42 65 72 72 79
KeyA: 4B 65 79 41 5F 66 6F 72 54 65 73 74 5F 75 73 65
密文: F8 B1 3C DA B8 5E C6 9B FA 0F 60 B8 CF A2 0F BE
```

## 通信流程

### 1. 握手获取 TokenA（临时会话令牌）

**发送（16字节明文）**
```
01 00 [14字节随机填充]
```

**接收**
```
81 00 [TokenA: 4字节] [未知: 10字节]
```

**示例**
- 发送：`01 00 34 4C 6F 63 6B 55 70 42 79 42 65 72 72 79`
- 接收：`81 00 16 9E 2C 46 01 00 01 0A 64 00 00 00 00 00`
- TokenA = `16 9E 2C 46`

### 2. 查询电量

**发送（16字节明文）**
```
10 02 [8字节占位] [TokenA: 4字节]
```

**接收**
```
90 02 [电量值: 1字节] [未知: 13字节]
```

**示例**
- 发送：`10 02 00 00 00 00 00 00 00 00 00 00 16 9E 2C 46`
- 接收：`90 02 61 AB 0B 32 01 00 01 0A 61 00 00 00 00 00`
- 电量 = `0x61` = 97/100

**注意**：电量上限为 `0x64` (100)

### 3. 打开钥匙盒

**发送（16字节明文）**
```
20 01 [TokenB: 6字节] [占位: 4字节] [TokenA: 4字节]
```

**接收**
```
A0 01 [状态: 1字节] [占位: 13字节]
```

**示例**
- 发送：`20 01 54 6F 6B 65 6E 42 FF FF FF FF 16 9E 2C 46`
  - 其中 `54 6F 6B 65 6E 42` 是6字节的 TokenB
- 接收：`A0 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00`
- 状态 = `0x00` (成功), `0x01` (失败)

## 关键参数

| 参数 | 说明 | 长度 |
|------|------|------|
| **KeyA** | 设备加密密钥（每台不同） | 16字节 |
| **TokenA** | 临时会话令牌（握手获取） | 4字节 |
| **TokenB** | 永久开锁令牌（设备绑定） | 6字节 |

## 实现要点

1. **所有消息必须加密**：使用设备的 KeyA 进行 AES-128-ECB 加密
2. **固定长度**：每条消息必须是16字节
3. **通信顺序**：
   - 连接设备
   - 发送握手指令获取 TokenA
   - 使用 TokenA 进行后续操作（查询电量/开锁）
4. **TokenA 似乎无重放校验**：文档提到设计用于防重放，但实测未发现校验逻辑

## 注意事项

- 文档中的 KeyA 和 TokenB 仅为示例
- 实际使用需要获取真实设备的这些参数
- 未知字节可能是随机数或保留字段