# OKGSS 挂锁蓝牙通信协议

## 设备连接信息

**设备识别**
- 设备名称：`OKGSS101` (前缀通常为 OKGSS)
- 服务 UUID：`0000FEE7-0000-1000-8000-00805F9B34FB` (0xFEE7)
- 写入特征：`000036F5-0000-1000-8000-00805F9B34FB` (0x36F5, WRITE, WRITE NO RESPONSE)
- 通知特征：`000036F6-0000-1000-8000-00805F9B34FB` (0x36F6, NOTIFY)

## 加密机制

- **算法**：AES-128-ECB
- **密钥**：固定密钥 (Communication Key)，每台设备可能不同
- **消息长度**：固定16字节，不足部分使用 `0x00` 填充
- **加密范围**：所有收发消息都需加密（接收到的通知数据也是加密的，需解密后解析）

## 通信流程

### 1. 握手 / 获取会话令牌 (Session Token)

APP 向设备发送初始化指令，设备应答中包含后续通信所需的 Session Token。

**发送（16字节明文）**
```
06 01 01 01 [12字节 0x00 填充]
```

**接收（16字节解密后）**
```
06 02 [未知: 1字节] [Session Token: 4字节] [9字节 0x00 填充]
```
*TokenA 位于索引 3~6*

**示例**
- 发送明文：`06 01 01 01 00 00 00 00 00 00 00 00 00 00 00 00`
- 接收解密：`06 02 01 17 D9 0E A7 00 00 00 00 00 00 00 00 00`
- **Session Token** = `17 D9 0E A7`

### 2. 查询电量 / 二次确认

**发送（16字节明文）**
```
02 01 01 01 [Session Token: 4字节] [8字节 0x00 填充]
```
*(TokenA 位于索引 4~7)*

**接收（16字节解密后）**
```
02 02 [未知: 1字节] [电量: 1字节] [11字节 0x00 填充]
```
*电量位于索引 3*

**示例**
- 发送明文：`02 01 01 01 17 D9 0E A7 00 00 00 00 00 00 00 00`
- 接收解密：`02 02 01 64 00 00 00 00 00 00 00 00 00 00 00 00`
- **电量** = `0x64` (100%)

### 3. 开锁指令

**发送（16字节明文）**
```
05 01 06 [Unlock Key: 6字节] [Session Token: 4字节] [3字节 0x00 填充]
```

**结构分解**
- `05 01 06`: 固定指令头
- `UnLock Key` (Index 3-8): 6字节开锁令牌 (设备绑定)
- `Session Token` (Index 9-12): 4字节会话令牌 (动态获取)
- `padding`: 3字节 (0x00)

**接收（16字节解密后）**
```
05 [状态: 1字节] [14字节 0x00 填充]
```
*状态位于索引 1*

**状态码**
- `0x01` 或 `0x02`: 开锁成功
- 其他: 失败

**示例**
- Unlock Key：`06 8F B0 CD F1 58`
- Session Token：`17 D9 0E A7`
- 发送明文：`05 01 06 06 8F B0 CD F1 58 17 D9 0E A7 00 00 00`
- 接收解密：`05 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00` (成功)

## 关键参数

| 参数 | 说明 | 长度 | 示例值 |
|------|------|------|--------|
| **Com Key** | 蓝牙通信加密密钥 | 16字节 | `38 22 D7 ... 19 9E C9` |
| **Session Token** | 动态会话令牌 (TokenA) | 4字节 | `17 D9 0E A7` (握手响应[3-6]) |
| **Unlock Key** | 开锁密钥 (TokenB) | 6字节 | `06 8F B0 CD F1 58` |

## 实现要点

1. **填充模式**：使用 `0x00` 进行补位填充。
2. **动态令牌**：必须先握手获取 TokenA，然后将其即时用于查询电量和开锁指令中。
3. **加密算法**：
   - 发送：AES-128-ECB 加密
   - 接收：收到数据后先用相同密钥进行 AES-128-ECB 解密，再解析指令头和数据域。
